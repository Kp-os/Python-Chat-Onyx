{% extends "base.html" %}

{% block title %}{{ room.name }} - Чат{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>{{ room.name }}</h4>
                <div>
                    <span class="badge bg-info" id="userCount">0 користувачів</span>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">Назад</a>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="messages" style="height: 400px; overflow-y: auto; padding: 15px; background-color: #f8f9fa;">
                </div>
            </div>
            <div class="card-footer">
                <div class="input-group">
                    <input type="text" id="messageInput" class="form-control" placeholder="Введіть повідомлення..."
                           maxlength="500">
                    <button class="btn btn-primary" type="button" id="sendButton">Відправити</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();
    const roomId = {
    {
        room.id
    }
    }
    ;
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    // Підключення до кімнати
    socket.emit('join', {room: roomId});

    // Обробка повідомлень
    socket.on('message', function (data) {
        const messageElement = document.createElement('div');
        messageElement.className = 'mb-2';
        messageElement.innerHTML = `
            <div class="d-flex align-items-center">
                <strong style="color: ${data.color};">${data.username}</strong>
                <small class="text-muted ms-2">${data.timestamp}</small>
            </div>
            <div class="ms-3">${escapeHtml(data.message)}</div>
        `;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // Обробка статусних повідомлень
    socket.on('status', function (data) {
        const statusElement = document.createElement('div');
        statusElement.className = 'mb-2 text-center';
        statusElement.innerHTML = `
            <small class="text-muted fst-italic">
                <span style="color: ${data.color};">${data.username}</span> ${data.msg.split(' ').slice(1).join(' ')}
            </small>
        `;
        messagesDiv.appendChild(statusElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // Відправка повідомлення
    function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
            socket.emit('message', {
                room: roomId,
                message: message
            });
            messageInput.value = '';
        }
    }

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Вихід з кімнати при закритті сторінки
    window.addEventListener('beforeunload', function () {
        socket.emit('leave', {room: roomId});
    });

    // Функція для екранування HTML
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function (m) {
            return map[m];
        });
    }
</script>
{% endblock %}
